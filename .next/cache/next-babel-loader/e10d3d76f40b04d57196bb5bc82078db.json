{"ast":null,"code":"import ItemInstance from '../../models/iteminstance';\nimport dbConnect from '../../utils/dbConnect';\nimport crypto from 'crypto';\nimport formidable from 'formidable';\nimport validator from 'validator';\nexport const config = {\n  api: {\n    externalResolver: true,\n    bodyParser: false\n  }\n};\n\nconst getHashedPassword = password => {\n  const sha256 = crypto.createHash('sha256');\n  const hash = sha256.update(password).digest('base64');\n  return hash;\n};\n\nexport default async function handler(req, res) {\n  const form = formidable({\n    multiples: true\n  }); // console.log('req.body: ', req.body);\n\n  var email, validatedemail, password, validatedpassword;\n  var errors = [];\n  form.parse(req, (err, fields, files) => {\n    console.log('I am in form parse');\n\n    if (err) {\n      console.log('err: ', err);\n      res.json(err);\n      return;\n    }\n\n    email = fields.email;\n    password = fields.password;\n  });\n  await dbConnect(); // validator text\n\n  if (validator.isEmpty(validator.trim(email))) {\n    errors.push(' The email is empty');\n  } else {\n    if (validator.isEmail(validator.trim(email))) {\n      validatedemail = validator.escape(validator.trim(email));\n    } else {\n      errors.push(' The email format is incorrect');\n    }\n  }\n\n  if (validator.isEmpty(validator.trim(password))) {\n    errors.push(' The password is empty');\n  } else {\n    if (validator.isLength(validator.trim(password), {\n      min: 6\n    })) {\n      validatedpassword = validator.escape(validator.trim(password));\n    } else {\n      errors.push(' The password must be at least 6 charactors.');\n    }\n  }\n\n  return;\n\n  if (errors.length > 0) {\n    res.status(500).json({\n      error: errors,\n      status: 500\n    });\n    res.end();\n    return;\n  }\n\n  const hashedPassword = getHashedPassword(validatedpassword);\n  User.findOne({\n    email: validatedemail,\n    password: hashedPassword\n  }).then(user => {\n    if (!user) {\n      var err = new Error('Invalid username or password');\n      res.status(404).json({\n        status: 404,\n        error: err\n      });\n      res.end();\n    } else {\n      res.status(201).json({\n        status: 201,\n        data: user\n      });\n      res.end();\n    }\n  }).catch(err => {\n    res.status(500).json({\n      status: 500,\n      error: err\n    });\n    res.end();\n  });\n}","map":{"version":3,"sources":["/Users/jiuhong8201/Desktop/HTML-CSS-JS-learning/A_Real_Project/my-next/pages/api/user_logon_post.js"],"names":["ItemInstance","dbConnect","crypto","formidable","validator","config","api","externalResolver","bodyParser","getHashedPassword","password","sha256","createHash","hash","update","digest","handler","req","res","form","multiples","email","validatedemail","validatedpassword","errors","parse","err","fields","files","console","log","json","isEmpty","trim","push","isEmail","escape","isLength","min","length","status","error","end","hashedPassword","User","findOne","then","user","Error","data","catch"],"mappings":"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","sourcesContent":["import ItemInstance from '../../models/iteminstance';\nimport dbConnect from '../../utils/dbConnect';\nimport crypto from 'crypto';\n\nimport formidable from 'formidable';\n\nimport validator from 'validator';\n\nexport const config = {\n    api: {\n        externalResolver: true,\n        bodyParser: false,\n    },\n};\n\nconst getHashedPassword = (password) => {\n    const sha256 = crypto.createHash('sha256');\n    const hash = sha256.update(password).digest('base64');\n    return hash;\n};\n\nexport default async function handler(req, res) {\n    const form = formidable({ multiples: true });\n    // console.log('req.body: ', req.body);\n    var email, validatedemail, password, validatedpassword;\n    var errors = [];\n\n    form.parse(req, (err, fields, files) => {\n        console.log('I am in form parse');\n        if (err) {\n            console.log('err: ', err);\n            res.json(err);\n            return;\n        }\n        email = fields.email;\n        password = fields.password;\n    });\n\n    await dbConnect();\n\n    // validator text\n\n    if (validator.isEmpty(validator.trim(email))) {\n        errors.push(' The email is empty');\n    } else {\n        if (validator.isEmail(validator.trim(email))) {\n            validatedemail = validator.escape(validator.trim(email));\n        } else {\n            errors.push(' The email format is incorrect');\n        }\n    }\n\n    if (validator.isEmpty(validator.trim(password))) {\n        errors.push(' The password is empty');\n    } else {\n        if (validator.isLength(validator.trim(password), { min: 6 })) {\n            validatedpassword = validator.escape(validator.trim(password));\n        } else {\n            errors.push(' The password must be at least 6 charactors.');\n        }\n    }\n\n    return;\n\n    if (errors.length > 0) {\n        res.status(500).json({ error: errors, status: 500 });\n        res.end();\n        return;\n    }\n    const hashedPassword = getHashedPassword(validatedpassword);\n    User.findOne({ email: validatedemail, password: hashedPassword })\n        .then((user) => {\n            if (!user) {\n                var err = new Error('Invalid username or password');\n                res.status(404).json({ status: 404, error: err });\n                res.end();\n            } else {\n                res.status(201).json({ status: 201, data: user });\n                res.end();\n            }\n        })\n        .catch((err) => {\n            res.status(500).json({ status: 500, error: err });\n            res.end();\n        });\n}\n"]},"metadata":{},"sourceType":"module"}